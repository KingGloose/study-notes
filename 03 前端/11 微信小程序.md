视频讲解：[黑马程序员前端微信小程序开发教程，微信小程序从基础到发布全流程*企业级商城实战(含 uni-app 项目多端部署)*哔哩哔哩\_bilibili](https://www.bilibili.com/video/BV1834y1676P?p=2)

视频讲解：前端系统课 - coderwhy - 微信小程序

# 1. 基本入门

## 1.1 基本介绍

> 什么是小程序？

![[00 assets/94f37e5bb8ca625fe9a5c795c0c5ee05_MD5.jpeg]]

![[00 assets/f4e4c32cb2c2983de5ca293d60843b86_MD5.png]]

> 各个平台为什么都需要支持小程序呢？

![[00 assets/8b4f03faca86531df7df885b2790c91b_MD5.jpeg]]

> 小程序由谁来开发？

![[00 assets/94b267d2df6c0c2fcbf4e69f8185d981_MD5.jpeg]]

> uni-app 和 taro

![[00 assets/320da0300519b4de97a54db0934ce1ad_MD5.png]]

## 1.2 项目结构

下面为`微信小程序`得整体得目录结构，也会是以后微信小程序开发的文件结构

![[00 assets/044d0ba28c43238e2894566b13451d1e_MD5.jpeg]]

> 每个文件

![[00 assets/8c5fb6e07c6543ec3c72dba499521693_MD5.png]]

> pages 文件夹

![[00 assets/e4e8ccaa9b7694b9af2c7a6c81c058d6_MD5.png]]

下图为`page文件夹`中得`.json`文件得配置

![[00 assets/4bd95e02a84346923bed440ffa76ac19_MD5.png]]

> app.json

![[00 assets/dbad62ab0caba5192b2e3bb828bd708b_MD5.png]]

> project.config.json

![[00 assets/cce471fcbcd266c6c7b3fd7293d6ea16_MD5.png]]

> sitemap.json

![[00 assets/302ea0bd51770e3ae6c20cee00d4af1e_MD5.png]]

## 1.3 创建 page

如果`创建page`得话只需要在`app.json`里面添加一个`"pages/list/list"`，就会在`pages`文件夹下面创建一个`list文件夹`，`list文件夹`下面就是相应得文件

其中排在第一位得会作为首页存在，如下图中得`pages/list/list`就是排在第一位，那么小程序打开展示得页面就是它

![[00 assets/bb3f0f2ed52ea30a09fb34967f87cab4_MD5.png]]

\*如果要使用`page`得话一定要在`app.json`中得`pages`中注册才可以

## 1.4 MVVM

下面的`MINA框架`就是`微信小程序`的框架

![[00 assets/f95a27be00897d47f3b980d14373d753_MD5.png]]

## 1.5 架构模型

> 双线程模型

![[00 assets/ec9b493b1c2ae65975292a8375854cb4_MD5.png]]

> skyline

微信官网中有介绍`skyline`的渲染引擎，但是目前只是一个`beta`版本，所以只需要稍微了解一下就可以了

![[00 assets/3b37c139cb352bc7e323f6f97d4238c8_MD5.jpeg]]

# 2. 基本使用

## 2.1 基本使用

下面是对于`微信小程序`的一个基本的使用，包含了`数据绑定`、`列表渲染`

![[00 assets/3bd1500f7f69285c58d033a85143a61e_MD5.png]]

下面是`事件绑定`的处理，其中数据的修改必须使用`this.setData()`处理，这个和`React`中的`setState`的语法很类似

![[00 assets/78f4390de6fabad020c699a7b9a44b36_MD5.jpeg]]

## 2.2 App

`App`文档：[App(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/reference/api/App.html)

![[00 assets/8e84d9645d6c6ae7890db6f0dea8067d_MD5.png]]

`App`中可以进行下面的操作

![[00 assets/f027d915f53c316170cf0aee7fe8c050_MD5.png]]

> 作用一：判断打开场景

**官方场景值文档**：[微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/reference/scene-list.html)

在生命周期函数中存在参数`options.scene`，用于判断进入小程序的方式，比如：扫码进入小程序就跳转到特定页面进行展示

![[00 assets/1bc1b020e8091ec04203bebb0276e822_MD5.png]]

> 作用二：定义全局 App 的数据

![[00 assets/b8ccb1b823da47f9aa21fccec6dbfdd4_MD5.png]]

> 作用三：生命周期函数

![[00 assets/54eb2c8b71b7158fdb6207f4a418d70a_MD5.png]]

## 2.3 Page

**Page 官方文档**：[Page(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html)

其中`Page`包含下面的作用，这个可以类比为`Vue`中的`Views`

![[00 assets/3b284e43248a1dc954a7fe8e18134f2c_MD5.jpeg]]

我们可以做`列表渲染`、`网络请求`、`数据初始化`

![[00 assets/33777a64be675ab4d7388c1cc1ca2c45_MD5.png]]

当然我们也可以`绑定事件`和`样式绑定`

![[00 assets/6d7e041a3e506f96600b08a950bb0fac_MD5.png]]

其中`上拉刷新`和`下滑触底`可以参考我`3.4.3`的笔记

# 3. 配置信息

## 3.1 基本介绍

![[00 assets/d0442375a61ed42a950723449b11513d_MD5.png]]

## 3.2 project.config.json

> project.config.json

`project.config.json`主要是在里面编写一些配置文件使用的，下图中就包含了基础库、appid...等信息。假如想要配置更多的信息可以参考官网文档：[项目配置文件 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/devtools/projectconfig.html)

![[00 assets/e9274533574624416f27d05e083dab09_MD5.png]]

> project.private.config.json

当然还存在一个`project.private.config.json`，这个主要是协同开发的时候使用的，作为自己的一个私有的配置信息存在

![[00 assets/9321ea5a1c35e6810a6c27912b665810_MD5.png]]

## 3.3 sitemap.json

`sitemap.json`这个主要是用于微信小程序检索使用的。

具体配置可以参考：

1、sitemap 配置：[sitemap 配置 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/sitemap.html)。

2、sitemap 介绍：[sitemap 配置 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/framework/sitemap.html)

假如你是政府单位的小程序肯定不希望被收录，所以我们需要手动配置`sitemap.json`文件。正常的商业项目肯定是希望被收录

![[00 assets/0b43516d8a5618c0832e4682a4eb1622_MD5.png]]

## 3.4 app.json

### 3.4.1 基本介绍

`app.json`这个主要是用于微信小程序设置一些全局配置。

具体配置可以参考：

1、app.json 配置：[全局配置 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html)

2、app.json 介绍：[小程序配置 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#全局配置)

下面就是比较常见的配置

![[00 assets/793a3e99a77bb9e6c372ad4f50749bdd_MD5.jpeg]]

### 3.4.2 pages

这里就是我们创建`page`的位置，假如你手动创建的`page`，但是不再这里配置是不行的。不仅仅是创建`page`，这还是一个配置路由的位置，比如项目后续的路由跳转和导航栏跳转，都需要使用到`page`中的配置

![[00 assets/9f557db605526abb61d0cde40cdb81e0_MD5.png]]

### 3.4.3 window

#### 3.4.3.1 基础配置

`window`比较常见的配置项，包含了`导航栏`、`loading`、`全局事件`....

![[00 assets/ed2a9e9fa0490445402a289943543e92_MD5.png]]

下面即是一部分的配置信息

![[00 assets/cde470c1057ea32d9c237ef6012ed526_MD5.png]]

#### 3.4.3.2 下拉刷新

我们在`window`的配置中将`enablePullDownRefresh`设置为`true`就可以开启全局的下拉刷新了，当然有全局的话就会存在局部，假如我们只想在局部开启下拉刷新，就需要在`page`中的`.json`文件中手动的开启使用

![[00 assets/aad8ca741aae57a6ffc05f4154e89bcb_MD5.png]]

当然我也可以在`.js`中使用`onPullDownRefresh`监听到`下拉刷新`，这里面可以编写一些网络请求相关的`API`处理。因为我们下拉刷新的时间比较长，我们可以使用`stopPullDownRefresh`来手动来关闭`下拉刷新`

![[00 assets/d7def0986850b8060f2fb4414ffc11e5_MD5.png]]

#### 3.4.3.3 上拉触底

设置上拉触底，也就是我们向下阅读的时候，屏幕往上划，划到了底部的时候要加载后面的内容，这个就是设置下拉触底的距离。假如我们需要配置的话可以设置`onReachBottomDistance`的距离，就可以开启了

![[00 assets/64ddd809bc48ae28038883fee11a963d_MD5.png]]

我们在`.js`中使用`onReachBottom`来监听到页面滚动到底部

![[00 assets/78be7461342355a026cb5a91534c8ca0_MD5.jpeg]]

### 3.4.4 tabBar

`tabBar`配置导航栏，下面是设置`tabBar`的常见的属性

![[00 assets/9f1a4d0d53abab71971ab43e277ba324_MD5.png]]

`tabbar`的配置选项

![[00 assets/ce5385825473ed64875ad00c2f430f93_MD5.png]]

单个`tab`的配置选项

![[00 assets/860a21179a61fc6146944071550d5ced_MD5.png]]

我们在`app.json`中就是按照下面的方式来配置`tabbar`

![[00 assets/007bb2bcffcd67c095ae955790eef2a1_MD5.jpeg]]

## 3.5 页面配置

![[00 assets/696ff1d67b327e5d9dec5df920f62fbd_MD5.png]]

下面为经常使用的`页面配置`的`配置项`

![[00 assets/62f2a8479e8e1b5ddc7d014c14f1fe08_MD5.jpeg]]

我们就是使用下面的方式来编写`配置项`

![[00 assets/172634306dea783b7012f7d88e876508_MD5.png]]

# 4. 常见组件

## 4.1 text

**text 官方文档**：[text | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/component/text.html)，`text`其本质就是`HTML`里面的`span`

![[00 assets/227fcbc18ca1c0bec3972bb3804c100b_MD5.jpeg]]

## 4.2 button

### 4.2.1 基本使用

**button 官方文档**：[button | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/component/button.html)

![[00 assets/1aa5ea936c9a97193d2e0deeb8f8c5f3_MD5.png]]

> 基本使用

我们可以为`button`设置不同的属性展示不同的样式，并且在小程序中`button`是块级元素

![[00 assets/31afc2e9c72ad7063ce71f06305ed603_MD5.png]]

### 4.2.2 open-type

![[00 assets/47e9a1b284b4e5f7f7593e7cdea24299_MD5.jpeg]]

## 4.3 view

`view`类似于`HTML`中的`div`，是作为一个块级元素占一行

![[00 assets/60757a52c2bab03610a42f59fa61393b_MD5.png]]

![[00 assets/fc54ffeafebade1fd500a90e0111c383_MD5.jpeg]]

## 4.4 image

### 4.4.1 基本使用

**image 官方文档**：[image | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/component/image.html)，其中`image`组件默认宽度**320px、高度 240px**

![[00 assets/edbd3a3c3d46238eb0e93f1fb1c2eccd_MD5.png]]

> 基本使用

1、这里有一个文档路径加载的小技巧：直接使用`/`的话就默认选择根路径，比如上面的`加载本地图片`中的`src`

![[00 assets/f7d49a380c904418b0e8df87d7b8c19a_MD5.jpeg]]

2、`image`存在一个`mode`属性，对于设置图片来说很方便

![[00 assets/9037658d3c9a1e50f6424a22da4a7689_MD5.png]]

### 4.4.2 chooseMedia

**wx.chooseMedia 官方文档：**[wx.chooseMedia(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/media/video/wx.chooseMedia.html)

`chooseMedia`可以用于`拍摄`或者`选择本地图片`。我们在本地手机选择图片之后可以本地展示，也可以上传云端

![[00 assets/5c2db4f925a196bd19aeb1cd51e64960_MD5.jpeg]]

### 4.4.3 previewImage

**wx.previewImage 官方文档**：[wx.previewImage(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.previewImage.html)

在新页面中全屏预览图片，可以查看大图保存图片、发送给朋友等操作

![[00 assets/b9ff4bfdea9ae3a00759a0654de8e2ad_MD5.png]]

## 4.5 scroll-view

**scroll-view 官方文档**：[scroll-view | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/component/scroll-view.html)

![[00 assets/d7aa242a88bc4a03b6c226f8482853a5_MD5.png]]

1、`scroll-view`本身是为了实现`局部滚动`，假如是全局滚动的话可以直接让`view`高度撑起来即可，就不需要使用`scroll-view`

2、假如你想`x轴`局部滚动的话，就需要宽度超出`scroll-view`。相应的想实现`y轴`局部滚动的话，就需要高度超出`scroll-view`

3、假如你想要`scroll-view`内部实现`flex`布局，就需要加上` enable-flex`来开启`flex`布局

![[00 assets/e4420495d528ccfdebe41c9216b83ae0_MD5.png]]

## 4.6 richtext

可以将 HTML 的节点，转换为微信小程序里面的节点

## 4.7 共有属性

对于每个组件来说，存在下面的`共有属性`

![[00 assets/5974cbd966a5d34c14a77d01b4528ef5_MD5.png]]

# 5. WXSS

## 5.1 基本介绍

**WXSS 官方文档**：[WXSS | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html)

> 编写位置

`wxss`本质和`CSS`是一样的。其中`全局样式`是对于`app.wxss`来说的

![[00 assets/9471c262a75bffa57ded78bf4076e015_MD5.png]]

> 支持选择器

![[00 assets/8752bf5a99af7795ab280418f5544df9_MD5.png]]

其中选择器遵循下面的权重

![[00 assets/df26c367d015d4558e335906fc04520b_MD5.png]]

## 5.2 rpx

`rpx`作为微信小程序特有的单位，其主要是为了解决多机型适配的问题

![[00 assets/b99d780611030a819d89d4eb68b2fcf2_MD5.png]]

# 6. WXML

## 6.1 基本介绍

![[00 assets/7cf068f4a4a4ea03b717d1126f042e0b_MD5.png]]

## 6.2 模板语法

![[00 assets/50beb0aba7931216ac8dcb7909c7c1f1_MD5.jpeg]]

虽然可以理解为`Vue`中的模板语法，但是还是有一些区别，比如该模板语法中不允许添加`函数`

## 6.3 条件渲染

### 6.3.1 基本使用

**wx:if 官方文档**：[条件渲染 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/reference/wxml/conditional.html)

`wx:if`本质和`v-if`是差不多的

![[00 assets/3580a822c9a5c7876604d30240f72fcc_MD5.png]]

### 6.3.2 hidden

类比于`Vue`中`v-if`和`v-show`的区别，假如频繁切换的话就使用`hidden`来处理，否则使用`wx:if`来处理

![[00 assets/d574001beaf941fb5b578c594f063ae7_MD5.png]]

## 6.4 列表渲染

### 6.4.1 基本使用

**wx:for 官方文档**：[列表渲染 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/reference/wxml/list.html)

![[00 assets/169abeab7f89ae0646de9ecccd066813_MD5.png]]

1、当然我们也可以使用`block`来处理，类比于`Vue`中`template`

2、还存在一个索引`index`，来表示遍历到那里

![[00 assets/43d7855b3e89830e17e34f3d2bd5b68f_MD5.png]]

### 6.4.2 修改别名

![[00 assets/bad2fc62823f86c0bd831f75b0acf002_MD5.png]]

### 6.4.3 key

![[00 assets/94c2383d6fb05641016db6773fcc46d5_MD5.png]]

# 7. WXS

## 7.1 基本介绍

**WXS 介绍**：[WXS 语法参考 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/reference/wxs/)

`WXS`本质是跑在`WXML`中的，因为微信小程序是双线程模型，一个渲染层，一个逻辑层，所以不能直接在`模板语法`中使用`函数调用`，所以就存在一个`WXS`直接跑在`WXML`

![[00 assets/2510022e288ce6c24ad1b334b6279855_MD5.png]]

## 7.2 基本使用

我们可以使用下面的方式来引入`.wxs`文件，注意`wxs`只支持`ES6`的语法，所以不存在`箭头函数`、`对象增强`、`import导出`....写法

![[00 assets/d9665f3fcf63bead06e5cb78269b1b93_MD5.jpeg]]

## 7.3 汇总

```javascript
// 为传入的数字添加￥
function formatPrice(price) {
  return "￥" + price
}

// 计算总价格
function totalPrice(bookList) {
  return bookList.reduce(function (preValue, nextValue) {
    return preValue + nextValue.price * nextValue.num
  }, 0)
}

// 传入一个10000，转换为1万
function formatCount(count) {
  var newCount = parseInt(count)
  if (newCount >= 100000000) {
    return (newCount / 100000000).toFixed(1) + "亿"
  } else if (newCount >= 10000) {
    return (newCount / 10000).toFixed(1) + "万"
  } else {
    return newCount
  }
}

// 时间100 转换为1:40
function padleft(time) {
  if ((time + "").length >= 2) return time
  return "0" + time
}
function formatTime(time) {
  var minute = Math.floor(time / 60)
  var second = Math.floor(time) % 60

  return padleft(minute) + ":" + padleft(second)
}


module.exports = {
  formatPrice: formatPrice,
  totalPrice: totalPrice,
  formatCount: formatCount,
  formatTime: formatTime
}
```

# 8. 事件监听

## 8.1 基本使用

1、因为微信小程序是手机上面的，所以没多少事件，下面就是常见的几个事件

![[00 assets/6c49d7660c7b95c8d6ae0f56886fe4b6_MD5.jpeg]]

2、在`.js`文件里面书写的时候，回调函数会有一个 event 参数

![[00 assets/4e9fae91aa322f06ec7111f431792382_MD5.png]]

3、关于 target 和 currentTarget 的区别

![[00 assets/1d0e011b39acbc5dd16b993de2700054_MD5.png]]

4、其大致的语法格式和 Vue 是差不多的，但是还是有一些细微的区别

![[00 assets/8af70db2788deccdd9cff8a2fa6803da_MD5.jpeg]]

其和 Vue 的区别主要集中在`修改参数`和`传递参数`

```javascript
// pages/list/list.js
Page({
  //数据
  data: {
    num:Math.random() * 10,
    num1:10,
    num2:0,
    text:"fafafa", 			 Url:"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg4.baixing.net%2F3d28c2293405e68f94fe1aac026c8a3a.png_bi&refer=http%3A%2F%2Fimg4.baixing.net&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1656486884&t=379e82e5ddf2ce5f8d71692b0b057eaf"
  },
  //带有event参数
  ShowEvent(e){
    console.log(e);
  },
  AddNum(e) {
    console.log(e.target)
    //修改参数，要调用setData函数,其实this.data就可以拿到data里面的参数
    this.setData({
      num1:this.data.num1 + 1
    })
  },
  ShowNum2(e){
    this.setData({
      //e.target.dataset.num2，就可以拿到传递来的参数num2
      num2:this.data.num2 = e.target.dataset.num2
    })
  },
  bindKeyInput(e){
    console.log(e.detail.value)
    this.setData({
      //文本框传递来的参数
      text:e.detail.value
    })
  },
})
```

```html
<view>
  <!-- 模板字符串使用 -->
  <image src="{{Url}}" mode="aspectFit"></image>
  <view>{{num > 5 ? '这是一个大于5的数字' : '这是一个小于5的数字'}},{{num}}</view>
  <view>{{num + 10}},{{num}}</view>
  <view>===============================</view>
  <!-- 展示event -->
  <button type="primary" bindtap="ShowEvent">点击我</button>
  <view>==============================</view>
  <!-- 事件绑定 -->
  <view>{{num1}}</view>
  <button type="primary" bindtap="AddNum">点击我</button>
  <view>==============================</view>
  <!-- 事件传参 -->
  <view>{{num2}}</view>
  <button type="primary" bindtap="ShowNum2" data-num2="{{3}}">点击我</button>
  <view>==============================</view>
  <!-- bindinput事件 -->
  <view>文本内容：{{text}}</view>
  <input value="{{text}}" bindinput="bindKeyInput" type="number"/>
</view>
```

## 8.1 事件分类

**事件官方网址**：[事件 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/event.html)

![[00 assets/46aed0932224be6778d4cb170e88ebe9_MD5.png]]

## 8.2 event

### 8.2.1 基本介绍

![[00 assets/c0501e138f725e3f6bb8b6202bdaf664_MD5.png]]

### 8.2.2 target 和 currentTarget 区别

其中`target`是触发事件的元素，`currentTarget`是处理事件的元素，所以按照下面的处理方式就有区别

![[00 assets/ab9aec104f0a6ceed2021eb13eaa5eb2_MD5.png]]

### 8.2.3 touches 和 changedTouches 的区别

![[00 assets/0cd53909c6048874bbc1f2dd7ed78c10_MD5.png]]

### 8.2.4 mark 传递参数

![[00 assets/6189d4ec9b9a59f52d5e1e9b82b98229_MD5.png]]

## 8.3 tab 案例

![[00 assets/71d710da3a8bf88efb841c5a0dd2421a_MD5.png]]

## 8.4 冒泡/捕获

> 基本介绍

![[00 assets/c52a3851f2365f8455e16d8ae631ac85_MD5.png]]

> 基本使用

![[00 assets/24944e9299c4b6d90377dbbde89228a0_MD5.png]]

# 9. 组件化

## 9.1 基本使用

1、右键创建一个`Components`，一般是丢到`components`的文件夹下，这里面存放的都是公共组件

2、在使用的地方的`.json`文件中的`usingComponents`指定使用即可，也就是说`components`、`page`都可以使用组件，只需要配置`.json`文件

![[00 assets/2fce15f66fbac6f789f6533d00c47ed5_MD5.png]]

使用`自定义组件`存在下面的注意事项

![[00 assets/1932c23ebffda91c5f410c3e9f2a8b3a_MD5.png]]

## 9.2 组件样式

按照下面的尝试，可以总结为：对于`class`来说是互不影响的，但是对于`id`、`属性`、`标签`选择器根据情况是各不相同的，所以编写尽量使用`class`来处理

![[00 assets/18730eceb42b655a2f2d9ba012636cbf_MD5.png]]

假如我们想要`page`中编写的样式也可以影响`component`的话，可以修改`stylesolation`属性

![[00 assets/ad2cd31a9cbb3bcbf636479c332ea6f7_MD5.png]]

![[00 assets/b660831b2dea132c218e148733271399_MD5.png]]

## 9.3 组件通信

### 9.3.1 基本介绍

![[00 assets/5af5c07c0ba6cd04df6689201d34cbce_MD5.png]]

### 9.3.2 properties

![[00 assets/ef821de5ab4c568b7753a07cc84adb65_MD5.jpeg]]

我们按照下面的方式来传递参数，和`Vue`中的`props`是一样的

![[00 assets/bc318b360610238f4f68692b1787b649_MD5.png]]

### 9.3.3 externalClasses

1、有时候，我们不希望将样式在组件内固定不变，而是外部可以决定样式。我们使用下面的方式来给子组件传递`class样式`

2、需要注意的是`externalClasses`不生效的情况，(1)不能使用驼峰命名，(2)组件内部有一样的类名被覆盖了

![[00 assets/36753cdbddf51f99767e18d2973966c0_MD5.png]]

### 9.3.4 自定义事件

1、微信小程序使用`triggerEvent`方法来发送事件

![[00 assets/3235a0876b4f989d7b986362dc286f67_MD5.png]]

2、父组件接受传递来的数据，使用`event`来接受数据

![[00 assets/3c7b836e780189e4f4929f080ad01bfa_MD5.png]]

## 9.4 获取组件

1、使用`this.selectCOmponent()`根据`类选择器`来获取组件实例，我们就可以调用里面的方法

![[00 assets/f61417538410bb942bebc424633c798e_MD5.jpeg]]

2、子组件中编写方法，其中第一个参数就是传递来的参数

![[00 assets/ec649d6b527b82b8f31f6f83857ff923_MD5.png]]

## 9.5 插槽

### 9.5.1 基本使用

1、和`Vue`中使用得方式基本一样

![[00 assets/97d3faa728cd49d406c9bc928b2ddeb7_MD5.png]]

2、我们也可以使用多个插槽

![[00 assets/53fe82a058da8f78f0d23b3ca9d70780_MD5.png]]

我们需要在对应得`组件`中使用`multipleSlots`开启即可

![[00 assets/5a3571d1e2169da7513f397c1e7f6380_MD5.png]]

### 9.5.2 默认插槽

小程序本身是不存在`默认插槽`这个语法得，所以下面只是一个方法来实现。我们使用`CSS`得伪类选择器来处理，只要`homeBannerStyle`下面为空得话，就让类名为`default`得`view`显示

![[00 assets/a133222a896ef47c4254cb8e7a80d479_MD5.png]]

## 9.6 behaviors

![[00 assets/31f98595bf1eaa9b596dc9b97ecf9192_MD5.jpeg]]

下面就是`behaviors`得使用方式，本质其实就是`Vue`中得`mixins`

![[00 assets/991830ffd7d0868b1470030db0c2757c_MD5.png]]

## 9.7 生命周期

![[00 assets/68dc2d90daf85814c9aa32cfe3fbc972_MD5.png]]

虽然上面存在这么多得生命周期钩子，但是作为组件真正使用基本都是下面得生命周期

![[00 assets/e02817e4ef22ab5c99c7c3871a4e3e7f_MD5.jpeg]]

我们在`组件`中可以监听`page`中得生命周期

![[00 assets/29edca023a9bcb6acb6e765261b569eb_MD5.jpeg]]

## 9.6 构造器

1、这里得`methods`需要注意和`page`不一样。在`page`中写方法不需要定义`methods`，但是在组件中需要

![[00 assets/0c12125ddb014bcbf9b9017e1818a068_MD5.png]]

![[00 assets/030a902abbcb498fcec0d7bd6aed6adc_MD5.png]]

# 10. API

## 10.1 网络请求

### 10.1.1 基本使用

![[00 assets/8a972f7ce9c34bc186bf9f7612f749af_MD5.png]]

下面为`wx.request`得基本使用情况，当然还有很多得参数

![[00 assets/78f1fb14c66e9d1d663f35a91b856f2e_MD5.png]]

作为微信小程序我们配置相应得域名需要在小程序得后台进行操作，文档：[网络 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/framework/ability/network.html)

![[00 assets/6942d1daf7a5d9664cbedc87d445dae9_MD5.png]]

然后还有一个`webview`业务域名得配置

1、不能带有端口，也就是你要使用`业务域名`得话，就需要默认端口为 443 给业务域名使用

2、需要将校验文件放置在目录下

![[00 assets/c243ded9c2a8f59791630f362ddb3fac_MD5.png]]

### 10.1.2 请求封装

> 函数封装

```javascript
export function WXRequest(options) {
  const { url } = options
  return new Promise((resolve, reject) => {
    wx.request({
      ...options,
      success: (res) => {
        resolve(res)
      },
      fail: (rej) => {
        reject(rej)
      }
    })
  })
}
```

1、我们可以使用下面得 2 种方式来进行请求，即`then`和`async/await`

![[00 assets/2632156b085665958668a96cb7550348_MD5.png]]

2、其中对于`async/await`得请求方式效率太低了，只有上一个请求完之后才会请求下一个。所以我们需要将其写在函数中，这样就可以同时发送请求

![[00 assets/2322f23790a7735dc14ca002d0cf6cd5_MD5.png]]

> 类封装

1、一般为了拓展性得话，我们都会使用`类`进行封装

2、我们可以在`constructor`中编写`baseURL`、`timeout`....基础信息，这样我们创建实例得时候可以直接使用

```javascript
class RequestService {
  constructor(baseURL) {
    this.baseURL = baseURL
  }
  request(options) {
    const { url } = options
    return new Promise((resolve, reject) => {
      wx.request({
        ...options,
        url: this.baseURL + url,
        success: (res) => {
          resolve(res)
        },
        fail: (rej) => {
          reject(rej)
        }
      })
    })
  }
  get(options) {
    return this.request({
      ...options,
      method: "get"
    })
  }
  post(options) {
    return this.request({
      ...options,
      method: "post"
    })
  }
}
```

### 10.1.3 上拉触底请求

1、我们使用`onReachBottom`来进行监听，只要触底就发送请求

2、对于请求来得数据我们使用一个新得数组往里面叠加，这样列表是连贯得

3、对于数据得更新，为什么`currentPage`不是使用`setData`来处理？这是因为我们修改了`currentPage`并不需要更新页面，所以不需要使用。这个和`React`得思想很想

![[00 assets/c8347a8d51656e49406a79f6a23fd0a5_MD5.png]]

## 10.2 弹窗

**官方文档**：[wx.showToast(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/ui/interaction/wx.showToast.html)

![[00 assets/6cc472a30a3ec63d9790387efa9f5d34_MD5.png]]

## 10.3 分享

官方文档：[Page(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html#onShareAppMessage-Object-object)

![[00 assets/7f270bffefe98862e8923d3cfb73aad0_MD5.png]]

## 10.4 获取信息

> 获取用户设备信息

**官方文档**：[wx.getSystemInfo(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/base/system/wx.getSystemInfo.html)

![[00 assets/aaf106eef2789d064bc87cc82d2ca550_MD5.png]]

> 获取位置信息

**官方文档**：[wx.getLocation(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.getLocation.html)

下面就是获取位置信息的方式，如果需要使用该能力的话，需要在`app.json`中添加`permission`字段

![[00 assets/24973dd3885c6858b8846ac13b235595_MD5.png]]

## 10.5 storage

**官方文档**：[wx.setStorageSync(string key, any data) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/storage/wx.setStorageSync.html)

这个可以参考`微信小程序`文档中的展示案例，但是这里需要注意下面的异步存储数据的方法，里面存在一个数据加密需要一定的时间并不是立马存储

![[00 assets/cb168dbc21015b4d5a533bb4d8245505_MD5.jpeg]]

## 10.6 页面跳转

### 10.6.1 基本介绍

**官方文档**：[wx.switchTab(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.switchTab.html)

![[00 assets/e127fdf95727bc61d4c04cde45361ae0_MD5.png]]

### 10.6.2 navigateTo

1、我们使用`navigateTo`进行路由的跳转，并且携带参数

2、如果需要接收的话，需要在跳转到的页面中的`onLoad`的`options`中进行获取

![[00 assets/27e307bb19eed6ae371149042e3d5b2a_MD5.png]]

### 10.6.3 navigateBack

其基本使用可以参考官方文档中的案例

![[00 assets/4de1f0c30c9251a7edd7ec2e6b21d9f3_MD5.png]]

### 10.6.4 上级数据传递

其中从首页跳转到详情页可以直接使用`query参数`，但是从详情页返回到首页还要传递参数的话就有点困难了

![[00 assets/e66fc7f889134f910cb387d34d2fb518_MD5.png]]

> 早期方式

![[00 assets/cc407cb4c1d463aefae2d532f105fdb5_MD5.png]]

![[00 assets/5a3c8a50e3a5eef73c0bcd41a3d28065_MD5.gif]]

> event 方式

1、我们使用`navigateTo`来编辑`events`

2、我们添加`eventChannel`即可，发出事件，即可传递参数

![[00 assets/3047ae3f079872ad6a22fcb2ee955844_MD5.png]]

### 10.6.5 navigator 组件

![[00 assets/6af81f175e431f92c9bc28d70903885d_MD5.png]]

## 10.7 登录流程

> 基本介绍

![[00 assets/5144f72c7da4bed8be6ce28c26aa70d8_MD5.png]]

> 小程序登录流程

![[00 assets/112e1a8afc81235d9a962be5174a6ced_MD5.png]]

## 10.8 页面生命周期

1、上面写的是组件的生命周期，下面是页面的生命周期

![[00 assets/2b575c48b9965da4e09b2e99b2e6c4f3_MD5.png]]

# 11. 云开发

## 11.1 基本介绍

### 11.1.1 整体介绍

> 完整的小程序

![[00 assets/89afaddd50d86829673742ba51d03f4f_MD5.png]]

> 开发成本考虑

![[00 assets/9459a6a234d487e2a7ca419a964b9a69_MD5.png]]

> 云开发模式

![[00 assets/9360fc72cd1781b0746cea9cb2aad43e_MD5.png]]

> 云开发模式和传统开发模式对比

![[00 assets/200258405bfef1856f761acba9b6fc57_MD5.png]]

> 项目流程对比

![[00 assets/ed54d1888d515a12f83f1f5773a72f9a_MD5.png]]

### 11.1.2 核心技术

![[00 assets/b04049b60beb113130eaaceef41f5edf_MD5.png]]

## 11.2 基本创建

> 基本使用

1、创建支持云开发的微信小程序项目

![[00 assets/c3be7398527ea4e36e2e771bac952aa7_MD5.png]]

2、这是点击云开发之后生成的文件目录

3、其中`cloudfunctions`表示是`云函数`，`miniprogram`对应的就是之前的工程文件，`uploadCloudFunction.sh`是批处理文件，将云函数统一上传

![[00 assets/75b7d20a13b867a490b34eb5017f41cd_MD5.png]]

> 云开发控制台

1、我们主要使用的是`数据库`、`存储`、`云函数`

![[00 assets/242735feabd2005fe728532fad6d8ad9_MD5.png]]

2、环境可以理解为一个服务器

![[00 assets/d2c25c81eecbfa6f8242b5c418619931_MD5.png]]

> 云开发初始化

![[00 assets/32cc05ed13702ab02fd501b4637841a5_MD5.png]]

1、首先要确保`app.js`中初始化了云开发，也就是`wx.cloud.init()`

![[00 assets/3b7fd7e5c59aedf41a2eaa0545c604d3_MD5.png]]

2、我们再`project.config.json`中也可以指定`项目文件夹`和`云函数文件夹`

![[00 assets/db2954e654e726cbf4f7960eae870ab7_MD5.png]]

## 11.3 云数据库

### 11.3.1 基本介绍

1、对于云数据库就可以理解为`mongodb`，其使用的方式基本差不多

![[00 assets/3f693b7a60f7d2344fde5ba247355c9e_MD5.png]]

### 11.3.2 可视化工具

1、云开发控制台存在下面的可视化工具，我们可以通过输入参数来添加参数

![[00 assets/7aa18c18ab8016d05fe9bc33ab448600_MD5.png]]

2、当然还存在`JSON`模式的传入参数。外层不能存在`key`只能存在对象，并且对象和对象之间不加`,`

```json
{
    "name":"zs",
    "age":18
}
{
    "name":"ls",
    "age":20
}
```

3、通过可视化工具就可以直接插入数据

![[00 assets/398cddf312496dda0611411bd6c67991_MD5.png]]

### 11.3.3 数据库操作

在操作之前要获取数据库和集合

![[00 assets/4375395cbacd40ba8899d31eb0a44583_MD5.png]]

#### 11.3.3.1 添加数据

![[00 assets/c66d493c93c2f51c330ece1e38abd29c_MD5.jpeg]]

1、我们使用`collection`的`add`方法来添加数据

![[00 assets/348035a8ef2873d9031e7dbaa6a96f10_MD5.png]]

2、对于结果的获取，有 2 种方式。第一种就是使用回调函数`success`，第二种就是使用`Promise`

![[00 assets/53dd9347cd8a8b9e99b9b04a6a1e9b9f_MD5.png]]

3、下面写的是请求斗鱼的数据，并且将数据都存入云数据库

![[00 assets/f7c457529b9e2bf87bb5ce2976380ed0_MD5.png]]

![[00 assets/71f8a8aed459060bb19f05421b3c382a_MD5.png]]

#### 11.3.3.2 查询数据

![[00 assets/125adbbc3f59d84f3ca42dff3c5dee50_MD5.png]]

1、对应上面各个查询方式的代码

![[00 assets/df02c6c9cd1a59ae2f3b726bed797af4_MD5.png]]

还可以通过`field`来指定返回的字段

![[00 assets/3eafc743e04d09a87c3076b80291dc32_MD5.jpeg]]

2、下面是常见的查询指令，官方文档：[指令 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/query.html)

![[00 assets/a35babbc76cac07d073a9f49e5be9102_MD5.png]]

3、对于正则的解释，一般我们使用正则来替代模糊查询。官方文档：[Database.RegExp | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/database/Database.RegExp.html)

![[00 assets/c9ef17f1dbdade58c4fe62c36b85c297_MD5.png]]

#### 11.3.3.3 删除数据

1、本质就是调用`remove()`方法，但是需要添加合适的查询条件

![[00 assets/c2981d7291127bf8bc001ba9529738f2_MD5.png]]

2、我们在使用的时候可能出现下面的问题，这是因为云数据库的权限问题，我们可以手动的添加权限

![[00 assets/706ff9fa2c62034ee356c629f6ed73d3_MD5.png]]

我们在数据库中修改自定义安全规则即可，这样就可以让用户可读可写了

![[00 assets/3cdedad82b4e83557fee5fe8c9636d48_MD5.png]]

3、在控制台可能存在索引问题，为了解决这个问题，我们只需要创建`_openid`和`_id`的索引就可以解决

![[00 assets/a2499b97e7dcfe7afc2c88389be593c0_MD5.png]]

![[00 assets/189410dd6b472f39775a7e289f7ce1d7_MD5.png]]

#### 11.3.3.4 更新数据

![[00 assets/e347b57929e76643fdddab74eaa20d26_MD5.png]]

1、和之前是一样的，都是写查询条件，然后调用`update()`或者`set()`方法即可

2、并且对于`update`和`set`之间是有区别的，其中`update`表示是更新其中的字段，但是其他的字段都不会修改；但是`set`表示覆盖该对象，其中只包含`data`中的数据。

![[00 assets/e196ff7abb961d8ce7dee6e32db8ab69_MD5.png]]

### 11.3.4 索引

1、我们可以在`云数据库`中添加索引，在现在的版本中是默认建立索引的

![[00 assets/738c547be9be2d6cd129716ef6d4d10a_MD5.png]]

2、其实本质就是数据库中的索引

### 11.3.5 数据库封装

```javascript
const db = wx.cloud.database();

class cloudDatabase {
  constructor(collectionName) {
    this.collection = db.collection(collectionName);
  }

  // 增加
  insert(data) {
    return this.collection.add({ data });
  }

  // 查询
  query(condition = {}, skip = 0, limit = 20, isDoc = false) {
    return isDoc
      ? this.collection.doc(condition).get()
      : this.collection.where(condition).skip(skip).limit(limit).get();
  }

  // 删除
  remove(condition = {}, isDoc = true) {
    return isDoc
      ? this.collection.doc(condition).remove()
      : this.collection.where(condition).remove();
  }

  // 更新
  update(condition = {}, data, isDoc = true) {
    return isDoc
      ? this.collection.doc(condition).update({ data })
      : this.collection.where(condition).update({ data });
  }
}

export default cloudDatabase;
```

## 11.4 云存储

### 11.4.1 基本介绍

![[00 assets/6eb6c4ecf230b6a6694035bcb117930d_MD5.png]]

### 11.4.2 可视化工具

1、我们也可以是由可视化工具来`上传文件`或者`上传文件夹`

![[00 assets/3aabfabaeb589e565e6bf2cc2d3d8acf_MD5.png]]

2、上传完成之后会有一个`file id`，可以将该地址放置于类似`image`中

![[00 assets/b8d1de7e4f53db44045b9ca44be7095b_MD5.png]]

### 11.4.3 文件上传

1、我们使用`wx.cloud.uploadFile`函数来上传文件

2、其中`filePath`表示文件的地址。`cloudPath`表示云端的地址，这里可以理解为存入云端的文件名，前面的`wallpaper/`表示云存储的文件夹

![[00 assets/8fd113e5771526c7cdca9c1f076f130f_MD5.png]]

### 11.4.4 文件操作

> 下载文件

![[00 assets/a918d7243931be026f004d089bfb91b0_MD5.png]]

> 删除文件

![[00 assets/9df471515119b7e5621f82e1ecaedd23_MD5.png]]

> 临时地址

![[00 assets/1e896871a3464830fa5392323a447434_MD5.png]]

## 11.5 云函数

### 11.5.1 基本介绍

![[00 assets/022a1c9b6ba796a4ccfed4338d9636f7_MD5.png]]

### 11.5.2 基本使用

1、首先我们需要创建一个云函数

![[00 assets/9b4ddab01404f601c4b61b88be0dd63e_MD5.png]]

创建完云函数之后就是下面的示例代码

![[00 assets/e07b38c60ab1c5a997425223de7b5c3b_MD5.png]]

如果看不到`云函数`的话，这是因为是同步下来的云函数，需要下载

![[00 assets/ee4470f38a7bad4e0811f1738fd1a3ed_MD5.jpeg]]

2、我们编写完代码之后需要上传并部署之后，才能使用

![[00 assets/5a678586aa88d9e1d6f6f676f948fb0d_MD5.jpeg]]

3、在云函数中返回的数据，会存入放回结果的`result`中

4、使用`wx.cloud.callFunction`来调用云函数，其中`name`表示云函数名字

![[00 assets/240cdd8f7248b8afdf384e3180116523_MD5.jpeg]]

5、我们给`data`传入参数，就可以在云函数中的`event`中使用

![[00 assets/09dd21f8fac3e05537800adcbd9cac3d_MD5.png]]

### 11.5.3 获取 openID/unionid

1、我们使用`cloud.getWXContext()`函数获取`openid`和`unionid`

2、但是我们没开通对应的功能，`unionid`是获取不到的

![[00 assets/40dffafa7291c6ee60e6cb7f2c320dbf_MD5.png]]

3、但是对于`openid`和`unionid`来说都是作为鉴权使用

4、它们存在区别，`openid`一般只在`小程序`和`公众号`中使用。但是你想做到多平台共享，就需要`unionid`，比如:该项目存在小程序、公众号、APP，你想让它们之间鉴权都一样的话就需要`unionid`

![[00 assets/549a0b0e4b852f23ba137a3ace7e6d2b_MD5.jpeg]]

### 11.5.4 云端调试/本地调试

1、我们打开云开发控制台，存在本地调试和云端测试

![[00 assets/2bc9138c607acc03bbce11b3ad67efa8_MD5.png]]

2、一般的情况使用`本地调试`

![[00 assets/50bce3dc7200771f939aa8efd9fada7d_MD5.jpeg]]

3、相当于传递参数`event`，但是一般很少使用云端调试

![[00 assets/b27dca9110b5406d036c1f09794c513b_MD5.jpeg]]

### 11.5.5 数据库操作

1、下面就是使用云函数的作用

![[00 assets/1c0c9b5c151e8066fc138d536ccf911f_MD5.png]]

2、我们也可以在`云函数`中直接操作数据库，并且返回数据

![[00 assets/b62a1193d0521f2006db4ab225a5b08b_MD5.png]]

### 11.5.6 发送 HTTP 请求

1、我们还可以使用`npm i axios`，因为`云函数`是运行在`node.js`中，所以可以和平常使用`node`环境是一样的

![[00 assets/41deafafc321da7a6eef700ef12c5644_MD5.png]]

2、但是需要注意的是，这里运行的`node.js`环境是`node 12`，所以不支持`ES Module`。只能使用对应的模块化导入，比如这里的`axios`是使用的`0.27`的版本，可能最新的版本已经不知道`CommonJS`导入了

![[00 assets/c6865b2158bb194b4837526b71c92f92_MD5.png]]

我们需要更换到对应的版本中

![[00 assets/c40df5a8f562554510ac167047834a8a_MD5.png]]

### 11.5.7 生成二维码

1、如果不是云开发的话，想要生成小程序码就很麻烦。但是使用云函数的话，它带有天然的鉴权，可以直接获取结果

2、按照下面的方式可以直接生成小程序码

![[00 assets/0341491b55b12eda5e165451d52116f1_MD5.jpeg]]

### 11.5.8 上传文件

1、其基本的上传流程就是下面的，和之前云存储中的上传是一样的

2、下面是获取小程序码，然后上传到云存储中，然后返回给小程序端进行显示

![[00 assets/6e0f5d3426e83651b21903a8778236fb_MD5.png]]

# 12. 其他

## 12.1 获取小程序码

1、在获取小程序码的时候，首先需要获取对应的`TOKEN`

![[00 assets/7c3a44b6f116c67aad2af995f857657f_MD5.png]]

2、再通过`TOKEN`来获取小程序码，并且这些操作都是后端来操作的

![[00 assets/9440782e1e1ddab201fb525e60144617_MD5.png]]

3、下面是不同的分类

![[00 assets/79e3675e4a6266a9c5b173c3de4acc96_MD5.png]]

# 13. 项目 - 云音乐

## 11.1 前期准备

1、创建项目，对于`AppID`来说在微信开发平台获取

2、我们先划分文件夹，下面的`assets`表示资源文件，`components`表示组件，`pages`表示`views`文件，`services`表示网络请求部分，`utils`表示封装的功能

3、然后就是创建页面，这里主要是 2 个`pages`，所以我们在`pages`中编写了 2 个文件夹。这个时候`app.json`就会自动添加路径

4、配置`tabbar`，按照下面的配置即可

![[00 assets/dc30f51587a980c7e127d3b16f66b490_MD5.png]]

## 11.2 视频页面

### 11.2.1 网络请求封装

1、对于网络请求，其思路和之前是一样的，我们这里直接使用`index.js`来处理。封装的`class`在我之前的代码中有，可以参考

![[00 assets/dd5cfb773bba9a48b3ec45e23d910b80_MD5.png]]

2、这里分为 2 个文件，一个是请求的实例，还有一个就是请求的接口了

![[00 assets/be5da26e6e30a8c22110881bca47df7a_MD5.png]]

3、在`page`中按照这样的方式来请求就行，因为网络请求是通用的，所以需要单独从`onLoad`中抽取出来

![[00 assets/4cdfa9fbcd8f7df2c9e4a4c3f838e650_MD5.png]]

### 11.2.2 mvItem 封装 - wxs 使用

![[00 assets/6b1b0079e786afee2e75efc077eb2edc_MD5.jpeg]]

1、对于这样的页面，我们需要抽取成组件。因为是组件，所以我们需要将数据传输给组件

2、这里数据的传输我们使用`props`来处理

![[00 assets/f1cc0c0c55401d154f04412ce3451fd6_MD5.png]]

3、获取`props`的值，再传入到页面即可

![[00 assets/b41bb07f94864a0aa7b42f5e57a4be46_MD5.jpeg]]

4、上面的逻辑和结构基本就是这样的，下面来说一下`小程序`中的样式部分。

![[00 assets/57d5a2cc362d0e0005c6408294f76db7_MD5.jpeg]]

首先就是，这个播放数和时长的处理，这里采用的是定位的解决方案

![[00 assets/ded0a95bc8864a6a65bb10b9f9258c7d_MD5.jpeg]]

5、并且对于小程序中的`backgroud-image`中不能添加本地图片，所以这里我使用的是`base64`的方式来处理的

![[00 assets/7f83e38d4fda9869d5c27109e56b17af_MD5.png]]

6、对于只显示 2 行字的处理，我们也采用 CSS 的方式

![[00 assets/2f4bb65475b2de447962ec725ccfd88c_MD5.png]]

7、在页面需要使用到函数的话，就需要采用`wxs`。下面就是基本的使用方式。

8、需要注意一个问题，对于`wxs`只支持`ES5`的语法，所以`箭头函数、let、import`都不存在

![[00 assets/4a9b51c4e30bdeda30de1b115e7b34f0_MD5.png]]

### 11.2.3 下拉/上拉刷新

1、因为刷新之后需要添加新的数据，所以需要改造网络请求的逻辑

2、我们修改数据需要使用`this.setData()`函数，并且重新渲染页面。但是对于`offset`来说，因为是依赖`TopMvList`的长度的，如果写进去可能就不是修改之后的数据，而是修改之前的，所以就会一直请求第一页的数据，所以我们这里直接修改里面的值即可

![[00 assets/d74c6aee61b378c815aed4ff309e9e62_MD5.jpeg]]

3、我们需要在对应的`.json`文件中写上属性，这样才能使用

4、因为服务器只会返回`50条`数据，所以这里需要采用`hasMore`来判断是否还有数据

5、下拉加载的时候，需要请求到数据之后，再停止加载即可

![[00 assets/524115f549f0c2941ebc0e17c2eae98f_MD5.jpeg]]

### 11.2.4 \*mvDetail 开发

1、我们点击`mvItem`之后需要跳转到详情页，但是这里存在 2 种开发方式。第一种就是点击之后，获取组件的`id`，然后在`page`中编写跳转的逻辑，但是这种写法需要写的东西比较多

2、第二种方式就是将点击的方式写在组件中，这样就直接获取组件中的`id`，这样写法更加简洁。这里采用的就是种方式

![[00 assets/0df4293197f25789ec9c4daaea6926b0_MD5.png]]

3、需要开发出下面的形式的页面

<img src="https://knowledge-picture.oss-cn-wuhan-lr.aliyuncs.com/202405032330186.png" alt="image-20230423205945182" style="zoom:50%;" />

4、其基本的逻辑就是编写网络接口，然后再编写页面

![[00 assets/422bb76c9b09fb1a819c86b10b12bf55_MD5.jpeg]]

5、然后请求到数据存入，然后让页面来渲染

![[00 assets/8863a23701f0142d6fdcc578d89e14c8_MD5.jpeg]]

6、对于视频播放的处理，微信小程序提供了`video`组件来处理，我们直接将视频地址输入就可以播放了。因为这个是分段加载的音乐，可能后续还会继续加载视频数据，所以我们这里需要修改`referrer-policy`的值

![[00 assets/47b87f8217355322bfc0f0f468024953_MD5.png]]

7、提供的`video`组件还存在弹幕功能，因为这种东西都直接是服务器返回的，但是现在服务器是没有弹幕的，所以这里写的是固定的，但是基本的形式就是这样的

![[00 assets/56e937c8bea8116e67dea3aad89e5828_MD5.jpeg]]

8、因为还存在下面的推荐视频的内容，这里我们封装一个组件`mv-related`

![[00 assets/9b9ad22239cace510369f3786e147d79_MD5.png]]

9、其基本的封装思路和上面的`mvItem`是一样的，这里就不去赘述了

![[00 assets/09d612e07ee3c0be6889773f43cb9616_MD5.png]]

10、对于推荐视频也提供有接口，在网上找`网易云API`就有了

### 11.2.5 内容滚动

![[00 assets/bb08621e6319dad433c34401c15a612f_MD5.jpeg]]

1、下面的内容是需要滚动的，但是上面的视频不能滚动

2、对于这种功能，有 2 种实现的逻辑，第一种就是将`video`的`position`为`fixed`，这样视频就固定到顶部了

3、还有一种实现的方式就是使用`scroll-view`来实现，下面就是采用这种方式

4、我们需要设置滚动条的长度，这里使用`CSS`计算属性来处理。`video`的高度默认就是`225px`，所以我们这里可以直接减去`225px`。我们这里还设置了`100%`，它是相对于父元素的`100%`，如果这个时候父元素没有设置高度的话，就是相对于内容的`100%`，这个时候高度就很高

![[00 assets/c07d572278b694ee27080034c9389d12_MD5.png]]

5、所以我们需要对父元素设置一个高度，这里依旧采用`100vh`的方式让父元素占据整个视口

![[00 assets/94baf77c69cad80eee43a5312ffe2a3c_MD5.png]]

## 11.3 音乐页面

### 11.3.1 Vant 库安装

1、安装`Vant库`，`npm i @vant/weapp -S --production`，然后需要在`工具` -> `构建npm`之后才能使用

![[00 assets/9b30fac8e223c8f573ad1022a93a34a2_MD5.png]]

2、我们在`.json`文件中注册组件，然后直接在页面中使用就行了

![[00 assets/09ec6843ee7c93c6ede4fe30ec5f661b_MD5.png]]

### 11.3.2 搜索框

1、我们这里直接使用`Vant`库中封装好的`搜索框`

![[00 assets/63f1e60902c2ddcd4cfecf3ca1de5fd1_MD5.png]]

2、这里需要修改样式，存在 2 种方式。第一种就是使用类名强制修改里面的属性，第二种就是使用`CSS变量`来处理

![[00 assets/eaf2677fc72226d5020da62a8480db04_MD5.png]]

3、因为我们使用了`Vant`库中的函数，但是官方库并没有及时的更新，所以有一些小的问题。内部一直有一些内容在报错

![[00 assets/2cf0780233ebcba221dc4fb83af4a166_MD5.png]]

第一种解决方式就是修改内部的源码，但是修改之后，如果需要迁移项目的话就很麻烦。

第二种方式就是降低微信小程序的版本库，我们将基础库降低到`2.18.0`之后就不会出现这样的问题

![[00 assets/15e70b30fae0dd35645577c1659cac1f_MD5.png]]

如果在选项中没有的话，我们可以直接在文件中修改也行

![[00 assets/6c5491cad3889fdd78515e32d2a9f824_MD5.png]]

4、点击搜索栏之后，需要跳转到搜索页面，这里查看官方文档中的事件监听就可以知道了

![[00 assets/05532d087ab75699e94d5310bf2dd5b8_MD5.png]]

![[00 assets/23a2296ea725113633b9cd9e94c4632d_MD5.png]]

### 11.3.3 轮播图

#### 11.3.3.1 基本实现 - CSS 样式

![[00 assets/d34f9877d745aa3c13c891e2293bcb4c_MD5.png]]

1、编写网络接口，请求数据到`page`中，页面渲染。我们使用`swiper`官方组件来设置轮播图

2、相应的`微信小程序`的`swiper`的选项查看文档即可

![[00 assets/d8c1f2020efbc6bb612b17b514878738_MD5.png]]

3、构建完成之后需要编写样式，首先在该界面的元素都会左右留有空隙，这里对全局设置`padding`。但是设置之后会出现`搜索框`再次压缩的情况

![[00 assets/a55217d80c9048ae627477b47947fd39_MD5.png]]

4、所以我们使用`CSS变量`来处理，`Vant`库在这里就是使用的变量来设置的

![[00 assets/e3a68574766361dea71e9a6fdf3413d4_MD5.png]]

5、随后便是设置轮播图的圆角，因为图片会顶出盒子，所以使用`overflow`来隐藏图片

![[00 assets/31d590a0bb75fc07c3af555d36869f27_MD5.png]]

#### 11.3.3.2 \*轮播图高度

1、因为`swiper`默认是`150px`，如果这样的话下面的点就会位于图片下面，我们想让`swiper`的点位于图片中

2、其中一个办法就是将轮播图的高度固定死，但是这样就存在机型不同，轮播图图样式不同的情况，所以这种方式不考虑

![[00 assets/386c0f3b3162aabaac68b160db0225e1_MD5.png]]

3、这里采用的是计算轮播图高度的形式。对于`image`组件存在一个事件，只要图片加载完毕就会自动调用

![[00 assets/72ed91bbbd7f3f0754218808984ee294_MD5.jpeg]]

里面存在一些`event`参数，里面包含了该图片的各种信息。我们可以计算图片的宽高比，并且计算组件的宽高来推算高度，但是这样的方式比较麻烦

![[00 assets/34180aa5c6f8b2a63cd32cb43a6aa49e_MD5.png]]

4、我们可以直接获取`image`组件的高度，设置给轮播图即可

5、在微信小程序中要获取高度需要一个新的`API`，`createSelectorQuery`放回一个实例

![[00 assets/a7d25ff3b7ea565efe8fcf15564713d6_MD5.png]]

6、但是这种方式获取元素很复杂，我们可以封装成一个组件来处理

7、回调函数中很难传递参数给外面，所以外面这里使用`promise`的方式将回调函数中的数据传输给外面，这个其实就是一种函数中传递参数的方式

![[00 assets/817aaef21a683f06d6c3248df1723b57_MD5.png]]

8、我们在`page`中获取高度，通过`{{ }}`方式动态决定高度的获取

9、首先我们想让点在图片中，本质就是图片覆盖整个`swiper`，我们将图片的`width`设置为`100%`，就相当于动态的决定图片的高度。所以我们获取图片的高度，设置给轮播图即可，这样就实现了不同机型的适配，动态的计算了轮播图的高度

![[00 assets/6a0a0966ab78cd8b2b7cc9be16f92a48_MD5.png]]

#### 11.3.3.3 \*获取节流

1、因为有很多的图片，我们不可能都去计算，我们这里使用节流的方式来提高性能。第一种方式就是使用自己编写的函数来节流

2、第二种方式就是使用`underscore`库来实现节流的操作，`npm i underscore`，然后构建`npm`

3、我们导出函数，并且给`throttle`函数，就可以实现节流的操作

![[00 assets/875d92b831f1ff799519975792ea3db3_MD5.png]]

4、最后调用节流函数即可

![[00 assets/fbbf965b7f4ddc6c2a8fb1b8ce17f3a9_MD5.png]]

### 11.3.4 头部标题封装

![[00 assets/495f821c4b6834b55ffd24fee4385d31_MD5.png]]

1、因为这个组件是经常要使用的，所以我们单独抽取成一个组件，并且按照下面的形式来设置样式

2、因为我们还需要点击更多之后跳转到推荐音乐的页面，所以我们还需要设置点击事件

3、这是一个通用的组件，我们通过自定义事件的形式，对父组件的函数进行回调

4、`areaHeaderTitle`表示标题，`hasMore`表示是否展示旁边的更多

![[00 assets/174d74a56efc8fa3b15b890486f0169d_MD5.png]]

### 11.3.5 推荐音乐 - 状态管理

![[00 assets/58848ea4b013d7f230ca36a6f895ee5f_MD5.png]]

1、首先是网络请求，然后放置到`page`中，再展示页面，这里做过很多这里就不过多的赘述了

2、很显然这种东西应该属于一种组件，所以我们封装为`musicItem`组件，并且通过`props`传递数据

![[00 assets/7442612e6a4993bf42736bb0238fb320_MD5.png]]

3、这个需求是首页展示 6 条数据，但是点击更多之后会展示 200 条数据，并且接口也是一次性返回 200 条数据，所以我们需要将着 200 条数据传输给另外一个`page`中，很显然小程序没有提供类似`pinia`的状态管理工具

4、所以这里就使用老师封装的`hy-event-store`库，来实现状态的管理，`npm i hy-event-store`

5、其基本的编写逻辑就是这样的，和`pinia`是差不多的

![[00 assets/25b2beb30ae0a9070583c050ce7a8073_MD5.jpeg]]

6、我们使用`import`导入之后。`onState`来实时监听该数据，只要数据变化就会调用该回调函数。使用`dispatch`来调用管理工具中的`action`，这样就实现了微信小程序的状态管理

![[00 assets/f3c6d13c000f7b6bbb11cdd9bf9bc993_MD5.png]]

7、我们直接在另外一个页面中监听即可

![[00 assets/8c1462b06e4699e2b8442691ba07d7a9_MD5.png]]

### 11.3.6 推荐歌单 - 全局变量

![[00 assets/d9fafbc3fb1bd0263d58238e5baf2899_MD5.png]]

1、网络请求，展示数据，很显然这也可以封装成一个组件

![[00 assets/dbd7c32007e759223de137010a8f4b1f_MD5.jpeg]]

2、对于该模块我们需要横向滚动，所以我们这里使用`scroll-view`来处理，并且设置为`scroll-x`让它横向滚动，并且让它支持`enable-flex`

3、这里重点就是设置样式，我们想让滚动条左右占满，所以设置`flex`布局，并且使用`flex-shrink`，让他们之间不再相互拥挤

4、因为全部设置了一个`padding`左右两边为`20rpx`，所以我们也使用`margin-left`来冲出全部的宽度设置。

5、并且每个盒子都需要间距，这里就使用了`margin-left:24rpx`设置

![[00 assets/d299674f02d988d5421faafdfa9da7fd_MD5.png]]

6、最后一条其实是最难的，老师没使用`flex`布局，这里直接参考它的视频。但是我这里发现直接设置为`padding-right`就可以实现右边的空隙

![[00 assets/fc3582484fa6a7c873f5fde69db87498_MD5.png]]

7、因为我们需要要让滚动条按照屏幕的宽度来设置，这里有一个方法`wx.getSystemInfo`，它会返回手机的系统信息

8、我们能获取到信息，数据就需要存放在一个全局的位置，因为该参数不会经常修改，所以我选择放置在`app`中

![[00 assets/17e5e2604e6dccb03d0234130c1f73c6_MD5.jpeg]]

9、我们使用`getApp()`来获取设置即可

![[00 assets/cfabc6bcdc3b1988866733de0c1bb811_MD5.png]]

### 11.3.7 热门歌单 - 组件抽取

![[00 assets/3697a9030647b89d480ae013a72c7732_MD5.png]]

1、网络请求，数据展示

2、你可以发现这个功能其实和`推荐歌曲`是一样的，所以我们这里可以抽取成一个组件，这样以后可以直接复用

![[00 assets/f27bb3c6ab24e9eae72f7e38fcf20288_MD5.png]]

3、我们在`main-music`中直接传递参数即可

![[00 assets/4694b753e870b7762a0d4cff53accf37_MD5.jpeg]]

### 11.3.8 更多歌单 - 组件样式/网络请求优化

![[00 assets/5ef270687c236d9ce9d6aa2e9335ed71_MD5.png]]

1、我们点击歌单更多之后需要跳转到该页面中

2、这里依旧是请求数据，数据展示，但是这里有一个小技巧

3、因为所有的工作都需要先获取标签，所以我们使用同步的方式来获取标签，因为根据标签来获取数据都是不相干的，而且无前后顺序要求，所以我们这里直接获取`promise`并且传入到`promise.all`中，这样就提高了网络通讯的性能。

4、并且网络请求之后再去使用`this.setData`，也就只渲染了一次页面，提高了运行的性能

![[00 assets/423c30da9e345267e230917d3100dea2_MD5.png]]

5、因为我们之前就封装了一个类似的组件，所以可以直接复用

![[00 assets/a0176bccc39a4d5523bc5945e1fcca69_MD5.png]]

6、我们引入组件直接复用

7、但是存在一个组件化抽取之后样式的问题，我之前直接将该组件的宽度写死，这样就导致了组件的复用性不高，需要后续手动修改样式

![[00 assets/5bf56a56d17a3aa65cda111f57545d37_MD5.png]]

8、对于类似的组件可以采取这样的样式编写的形式，给父组件设置`width:100%`

![[00 assets/cd2af32ab6b350260c2395c4c0d0b320_MD5.png]]

这样该组件的宽度就通过使用者的样式来决定了

![[00 assets/81e8f64b1db305641e91a4b75cd3a6a3_MD5.png]]

### 11.3.9 巅峰榜 - 数据映射

![[00 assets/00fac43847fb58b210ee36b5094e189a_MD5.png]]

1、我们要实现这样的榜单，因为这个数据需要在不同的页面中展示，所以我们需要将这些数据存放在`store`中

2、我们这里使用`对象`的映射来表现数据，并且采用下面的方式来请求数据就达到所有数据都是异步请求

![[00 assets/bca717be9348d1f4a8e536f1268e9308_MD5.png]]

3、请求到数据之后就需要监听该数据，并且调用里面的方法

![[00 assets/cbce5375c5df8121b3f456b57ac35909_MD5.jpeg]]

4、剩下的就是页面展示部分了，这块区域很显然要抽取为一个组件

![[00 assets/4365617445c45831ada1a48b666a7a98_MD5.png]]

![[00 assets/18557099e76c05362b2f70a42f649cf8_MD5.png]]

### 11.3.10 获取音乐列表

![[00 assets/7532c0e4f6a317ee0d155008dc8fc37f_MD5.png]]

1、我们点击排行榜之后会进入到这个页面

2、这个本质就是获取数据，并且存入到`store`中，这个在我获取巅峰榜的时候就存起来了

![[00 assets/9817e36c44647a506c14bcac9031b4b6_MD5.png]]

3、我们点击之后会引入该数据，这个时候我们就需要使用`type`或者`value`来区分，是从那个入口进入的

![[00 assets/3c93b3b1d1e429929a75251a621e8460_MD5.png]]

4、随后便是根据`type`设置值，重新渲染界面

![[00 assets/50c56a16d3c1f24425c189bd514235a4_MD5.jpeg]]

5、因为点击歌单之后还存在上面的歌单图片的展示

![[00 assets/2f2d85892003003ed56bc88e4c02e00e_MD5.png]]

所以我们这里直接封装成一个组件来使用，使用`if`来判断

![[00 assets/ae6eb8111c127423055491b00b292729_MD5.png]]

6、对于小程序来说，我们要传入`bool`类型，要使用`{{ }}`来传入

![[00 assets/b601da112e9fd0de867d6177ea45ed72_MD5.png]]

## 11.4 播放页面

因为该部分的逻辑比较复杂，所以这里只写思路。建议直接看代码

### 11.4.1 获取数据

![[00 assets/1b4e8245c8d81fa202741c6fab9e21da_MD5.png]]

1、点击了这个`item`，就会自动跳转到播放界面，并且传递参数

2、按照我之前封装组件的喜好，我会将事件传递出来，内部参数都是外部规定的。但是这个组件如果这样编写会很难做，所以我直接就在内部传递参数

![[00 assets/168b5b4834978ec2484db17ff8857755_MD5.jpeg]]

3、参数传递之后就需要跳转页面，并且需要给页面传递参数

4、参数传递之后就需要进行网络请求，然后就是页面渲染了

![[00 assets/fa798da759bd33ddf8fe3d623fd17a07_MD5.png]]

### 11.4.2 \*自定义导航栏

![[00 assets/6af8f9c1600ec43a22f01e3514ca347f_MD5.png]]

1、对于微信小程序是允许我们设置导航栏，我们需要在`.json`中配置

![[00 assets/a4ffecfe564d28a4ded32849543b83b5_MD5.png]]

2、这个是我编写自定义导航栏的`HTML`结构。因为我们设置为自定义导航栏之后，文字的显示会在状态栏中显示，所以我们需要手动设置高度

3、但是这个高度不是固定的，因为不同的机型它的状态栏高度都是不一样的，所以我们需要动态设置

![[00 assets/29a79f827b5aff9e69634893c0e9490c_MD5.png]]

4、我们依旧使用`getSystemInfo`来获取状态栏高度

![[00 assets/3b4d4c1084ec6e3c3ac2cf4f02459325_MD5.png]]

5、随后动态设置即可

![[00 assets/08cce7d3393472d1689d8273e1302543_MD5.png]]

6、然后就是设置中间的主体部分，我们按照下面的结构搭建即可

7、但是这里存在一个插槽的使用，这个参考我之前的笔记

![[00 assets/521dbd3827e060062a4fb34ca233eb26_MD5.png]]

8、切记，使用插槽之前一定要开启`options`

![[00 assets/7a1c20cc2557c487461f4119cf2a929f_MD5.png]]

9、而且对于`微信小程序`中是没有默认插槽值得，所以我们需要手动使用`CSS`来设置。下面得意思是`.default`默认设置为`none`，如果`.slot`为`empty`得话就设置为`flex`

10、设置这个`flex`是因为要取消`image`下面多余得`4px`，如果没这个需求设置为`block`也行

![[00 assets/d3b445613638937b4cb0d20763c066b6_MD5.png]]

11、随后设置在使用组件得地方设置插槽就行

![[00 assets/11d6671cd7fadf1619a90cac16f16a17_MD5.png]]

### 11.4.3 \*导航切换

![[00 assets/c2e8107146ee63872acf0c2214bb4c11_MD5.png]]

1、我们滑动下面得音乐页面就需要在不同得`page`中切换，这个存在 2 种思路。第一种就是使用`scroll-view`设置为`x轴滚动`。第二种方式就是把它当作轮播图来编写。很显然把它当作轮播图来编写会更加简单，所以我这里就采用这种方式

2、我们监听`swiper`得滚动，内部存在一个`event`记录了当前滚动到第几页

3、设置`currentIndex`之后就需要改变`navBar`得字体加粗

![[00 assets/9c89d6128713d3bb609a024b9b12768e_MD5.png]]

4、因为`swiper`默认是由内容撑开得，状态栏是动态决定得，所以`swiper`也需要动态计算得来

5、`swiper`高度 = 屏幕高度 - 状态栏高度 - `navBar`高度

![[00 assets/d9cbc4b837497a6d4397faf321651f25_MD5.png]]

6、我这里就动态定义了全局得`navBar`得高度，这样需要修改得话直接改这里就行

![[00 assets/966e7951213ef07e5e929f923704bf18_MD5.png]]

7、我们还可以点击上面得文字来切换

![[00 assets/d3a784652c29b241a58db5659d07c25e_MD5.png]]

8、点击之后设置`currentIndex`。然后使用`current`来作为索引

![[00 assets/6b48b1dc5f583ebd88656df32c2bbfab_MD5.png]]

### 11.4.4 页面展示

![[00 assets/35841e3035e7b4eeae87646da94ff948_MD5.jpeg|128]]

1、数据请求，页面展示

2、我这里分为 5 个部分，依次展示。随后就是编写样式了，这里就不去赘述

![[00 assets/a02134efcf71397a6ba1a0e800e6f818_MD5.png]]

### 11.4.5 歌曲播放

1、歌曲得播放，外面使用微信小程序内置得 API，也就是`wx.createInnerAudioContext()`

![[00 assets/6eac13fb80454e275a282c6b1f188ac2_MD5.png]]

2、我们设置`src`和`autoplay`就可以进入页面自动播放

![[00 assets/33aa0ddb172a5d62a8c4b92605b521bb_MD5.jpeg]]

3、当然`微信小程序`中有对应得文档直接参考

4、这里有一个 bug，我们设置了`autoplay = true`可以自动播放，但是再设置`onWait`监听之后`autoplay`就失效了。我这里使用的方式是，因为`onWait`是针对`滚动条优化`的，只要我们人为操作滚动条的话就设置为`false`，只要再播放这个歌曲就设置为`true`来阻塞`onWait`

5、使用`isFristShowPlay`来控制函数是否执行

![[00 assets/d6fa3f8ce28ff52090acdb305a0fe49b_MD5.png]]

只要每次播放其他音乐就会改为`true`，这样就不会执行`onWaiting`内的函数了

![[00 assets/a30c03ffc2db69a01c53de65bb20c637_MD5.png]]

只要拖动了滚动条就改为`false`，这样`onWating`还可以继续执行下面的代码

![[00 assets/34c3b2d12ad78a8c129f3228ff0e88ff_MD5.png]]

### 11.4.6 滚动条

#### 11.4.6.1 基本实现

1、对于`audioContext`存在`onTimeUpdate`监听事件，只要音乐播放时间变化就会调用该回调函数

2、我们这里得`currentTime`使用`audioContext.currentTime`来获取当前时间，然后动态计算滚动条得数据

![[00 assets/29684c51694582e020690110db4504ca_MD5.png]]

该内容还会动态计算底部时间

![[00 assets/4b19e5478054188626d2d9b66041e9ab_MD5.png]]

计算出得值传入到`slider`中得`value`，该值只会在是整数得情况下变化，内部自动做了节流

![[00 assets/c9b02a4b8f71ae2c5e6755d64f91ef5e_MD5.png]]

3、因为还需要音乐得时长数据，因为该接口是动态加载数据得，所以使用`audioContext`会出现时长不对得情况，所以这里使用接口中获得时间

![[00 assets/45508b790fe7d62181c7aed82717dcd5_MD5.png]]

#### 11.4.6.2 点击跳转

1、我们点击滚动条需要跳转到指定得时长得部分

2、因为我这里封装为组件，所以我传递事件出来

![[00 assets/80fd692378c7cf883781ec7cfece7030_MD5.png]]

3、使用`audioContext.seek`来设置音乐得时长，设置之后再设置`currentTime`

![[00 assets/1ce6262798b68f85142d571d6da9f91e_MD5.png]]

4、因为我们点击之后数据可能还没缓存过来，所以我们需要先暂停，缓存到了之后再播放

![[00 assets/547d93729a6b0973cbe5a87889b2a4a0_MD5.png]]

#### 11.4.6.3 拖动播放

1、我们拖动滚动条之后也会自动改变时长。这里使用`bindchanging`来监听事件

![[00 assets/00c877a9296bbe3f0d1d7248dfcae231_MD5.png]]

2、我们需要`isChangingSlider`来表示是否在拖动，如果拖动就不去实时加载音频数据

3、并且该函数使用了节流，我们这里使用了`underscore库`中得`throttle`来实现

![[00 assets/1a78a92a7c72a87a7165a17c5f94172f_MD5.png]]

使用`isChanginingSlider`之后就不会去动态渲染进度条了，也就避免拖动时滑动条跳动得`bug`

![[00 assets/29a37e846ee392431945b0e666bd2f19_MD5.png]]

### 11.4.7 歌词解析

1、这是歌词解析得函数，因为传来得歌词一般都是有规律得，所以可以解析

![[00 assets/e8de167aef092a3addccaa29b8c2af07_MD5.png]]

2、我们使用`for`来遍历，这就是一个小算法

![[00 assets/88902b16deb7f1ecc2c7d3e6937df397_MD5.png]]

3、这里直接参考代码即可

### 11.4.8 播放列表

1、我们点击下一首或者上一首的时候肯定是需要一个播放列表的

2、所以播放列表属于多个页面都需要的，所以我们使用`store`的方式来存储

![[00 assets/edbab0e87d35cae030207deb551d8d90_MD5.png]]

3、点击歌曲之后传入`列表`和`索引`

![[00 assets/f106ded17017645371af42a4b6a5c22c_MD5.png]]

4、在`onLoad`中监听即可

![[00 assets/b19cadf300b499530a77470d05e6e14a_MD5.png]]

### 11.4.9 上一首/下一首

1、既然我们都能获取到歌曲的列表了，我们也可以做上一首和下一首的功能

2、在做功能之前，我们需要抽取播放功能的核心代码，这样我们直接传入`id`即可播放下一首

![[00 assets/828ebea53e38c9ff6b703212f9f7e8bb_MD5.png]]

3、我们获取共享的歌曲的索引和列表

![[00 assets/42d9116be0c9693ed02369a43df2e41c_MD5.png]]

编写边界判断的条件，并且根据条件来计算

![[00 assets/1084f0b2cda1e229fc47bf020bef955f_MD5.png]]

### 11.4.10 播放模式

1、组件中发出事件，并且根据数据来计算现在处于那种模式

2、而且还需要将该数据传递给父组件，这样父组件中就可以做判断了

![[00 assets/e66bf9f14888a570a1358ce441d5bd8b_MD5.png]]

3、因为下一首和上一首的逻辑都封装起来了，所以我们也需要判断切换的模式

4、如果是列表播放的话，就默认下一首。如果是随机播放的话，就随机生成数字进行播放，并且这里需要注意不能和上次随机到的数字一样

![[00 assets/095def9c33ef1888f599560e1fc2cfae_MD5.png]]

5、因为还需要一个列表循环，这个表示的意思是依旧可以下一首，如果是自然播放完毕就一直循环着一首

6、微信小程序的`audioContext`提供了一个`API`，`loop`来表示是否循环播放

7、我们在模式切换的时候也切换一下`loop`的值

![[00 assets/00da6763508eaec70a6be9c23a7fd594_MD5.png]]

8、如果实时自然播放完毕就不执行`playNextEvent`的方法

![[00 assets/61a43cb75d761c62f2e23f27d3b21ce2_MD5.png]]

### 11.4.11 播放完毕

1、使用`audioContext`的`onEnded`事件，只要自然播放完毕就下一首

![[00 assets/dc2df98e0a970f9d06ab21e15f42f52b_MD5.png]]

## 11.5 歌词页面

### 11.5.1 页面展示

![[00 assets/c4146f00b2280f5c229105d6754dfb26_MD5.png]]

1、获取数据并且展示。我们这里使用看`scroll-view`来表示滑动

![[00 assets/fba79a5ec7e65f5233ed7510cafb437d_MD5.png]]

2、这是样式部分。因为只是基础部分，所以这里就不过多赘述了

![[00 assets/ebdcde15419d5a27fc880cc7ad730a4f_MD5.png]]

### 11.5.2 歌词滚动

1、这里采取的措施是使用`微信小程序`提供的`scroll-top`来移动滚动条

2、添加`scroll-with-animation`让滚动有动画

![[00 assets/8537a79a8768b2677959cac2f27cef4e_MD5.png]]

3、这里存在一个 bug。因为我设置的滚动高度是固定的，但是歌词有多有少，可能存在滚动偏差的情况

## 11.6 代码抽取

我这里存放了未抽取和已经抽取的代码，可以对比查看，而且我还设置了`git`

1、我们将核心的播放逻辑都抽取到`player.js`中

![[00 assets/2d905b816af5dec047c5e4d4fcb46b97_MD5.png]]

## 11.7 浮动播放器

![[00 assets/3a0ad7fa1007cb2f18a459d8c96a2f19_MD5.png]]

1、下面是`HTML`结构

![[00 assets/891cd86004f88ca3b8cdcf1980c2a329_MD5.png]]

下面是`CSS`结构

![[00 assets/2b6e8d3fc50323a39f536d5c7d47b67c_MD5.png]]

2、因为我们之前已经将核心代码进行了抽取，所以直接调用即可

3、因为我之前的数据都是实时加载的，并且通过`eventbus`来实时监听，所以我们直接跳转到`music-play`中即可

![[00 assets/4a0f0ca2a712517df080a42d027b069f_MD5.png]]

但是在`music-play`中需要做处理，因为没有传入`id`，所以就是继续听之前的歌

![[00 assets/7f6108965682db4e87bb222ba555a25d_MD5.png]]

## 11.8 分包

### 11.8.1 基本介绍

官方文档：[分包加载 | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages.html)

> 基本介绍

1、我们在详情中可以查看`本地代码`中的代码依赖分析

![[00 assets/4cfdfc2fe49c00b248a508b466b1f968_MD5.png]]

可以看到不同文件中各个文件的大小

![[00 assets/12a4158c16823fa2e9f45f2d847dd7af_MD5.png]]

> 独立分包

1、正常分包需要主包加载完毕之后才会加载该`独立分包`，这需要该包不依赖主包的任何东西

![[00 assets/9ab70d0a913497dfbc6fc018457f1bed_MD5.png]]

2、如果要使用的话，添加`independent`配置即可

![[00 assets/671eab425ef8ddbea7018ace33577271_MD5.png]]

> 分包预下载

1、我们可以配置，再下载某个包完成之后，立即下载其他包

![[00 assets/11a037c1b73cf1acf00daac265a8b8b8_MD5.png]]

2、我们可以配置`preloadRule`，就表示分包预下载

3、`pages/main-music...`表示该包下载完毕就会下载下面配置的包。`packages`表示要下载的包，它可以配置`root`和`name`中的值，`network`表示在什么网络时下载，`all`表示所有网络都下载

![[00 assets/22b8452ba91eb684794c262d8e8f1d56_MD5.png]]

> 分包异步化

1、如果`video`中封装了需要的`组件`和`函数`，但是我们需要在`play`中使用。但是`video`中配置了分包，所以不一定在`play`中可以引入到，所以就可以配置分异步化

2、这样就可以在`play`中配置替代，该方式查看文档来解决。因为这种需求一般很少

### 11.8.2 基本使用

1、我之前的文档结构只存在`pages`包，我称为该包为主包，我们在一开始加载小程序的时候就会全部加载下来

2、但是我们分包之后就只会加载我们需要的包，我们不点击分包的页面就不会下载，这样加快了首屏加载的速度。下面是未分包之前

![[00 assets/c1184916de80aa917d9311027abe5d39_MD5.png]]

3、我们将包分为下面的形式

4、可以看出，包分为`musicPlayer`、`musicSearch`、`musicVideo`，它们对应的就是`music-play`、`detail-search`、`detail-mv`

![[00 assets/ff6b729cc3528a112683b2a92f1ede5d_MD5.png]]

5、但是我们分出来之后，微信小程序不一定知道如何查找包，这个时候就需要在`app.json`中配置

6、下面的`subPackages`就是分出来的包，`root`表示根文件夹名，`pages`表示下面的包

![[00 assets/d5d3f579a7313c7080cd8b06642c7aae_MD5.png]]

6、我们将包分出来之后，相应的地址都需要修改

7、对应的`路由`地址也需要修改，在最前面加上`根文件名`即可

![[00 assets/9d4adc24909d3887b33a4c9493c0b54e_MD5.png]]

8、对于`.json`中引入的组件也需要修改，注意最好使用下面的方式来编辑路径，如果使用`../../components....`会造成路径寻找不到

![[00 assets/eabc514a93bf4496d082316434f941c8_MD5.png]]

9、可以看到分包之后，就可以看到下面我们分的包的文件大小了

![[00 assets/58c0332b648aec7566e5d4ce425deb29_MD5.png]]

### 11.8.3 Vant 库优化

1、我们需要手动来删除`Vant`库的的文件

2、我们根据使用到了组件，来一层层查找库中的文件，并且记录之后，手动删除

3、下面就是我们这个项目中剩余的文件夹

![[00 assets/c85b4817d0da6acac8b1d8120f483c09_MD5.png]]

## 11.9 云开发

### 11.9.1 我的页面

![[00 assets/4237dbe80850a1b3722f57c3c6ff1b27_MD5.png]]

1、因为有收藏和喜欢的功能，所以我们需要添加一个`我的`的`tabbar`，这些步骤直接查看之前的代码即可

2、下面就是页面的开发中`HTML`的结构

![[00 assets/d86ef11201a9823aa9fa93ac1b32ae48_MD5.png]]

### 11.9.2 云开发搭建

1、首先要创建对应的`云开发`环境，并且创建`云函数`的文件夹

![[00 assets/94a880f2c2b28911f597ba22b8a2b8db_MD5.png]]

2、我们在`project.config.json`中写入`cloudfunctionRoot`配置，并且指出对应的文件夹名字，就可以配置对应的云开发环境

3、如果没有配置上可以重启微信开发工具

![[00 assets/cff305a74fc6ec4176c50bd01a515964_MD5.png]]

4、这里我们暂时只使用获取`openid`的能力

![[00 assets/243728b0e77e34b4dbb0ee062d157e63_MD5.png]]

### 11.9.3 登录功能

1、因为微信小程序获取用户信息政策已经修改了，所以要按照下面的版本号对应的方式来处理

![[00 assets/3b57ef3a7c5889724d7f88a100832e36_MD5.png]]

2、我这里使用到的版本号未`2.31.1`，所以我使用`头像昵称填写能力`的方式来处理，为`open-type`添加选择头像的能力，并且做出对应的事件监听

![[00 assets/3fd8a1232291f690a44cd12914a6acf6_MD5.png]]

3、头像的地址会传递进`event`，我们需要将获取到的信息存入到`storage`中

![[00 assets/08b93eb118c784e1c4672637591fb7bd_MD5.png]]

4、我们还需要注意，一开始加载页面的时候也要获取登录的状态

![[00 assets/8a5fcc2bc299ad58e6cb748f8e288ab8_MD5.png]]

### 11.9.4 收藏/喜欢

![[00 assets/da887f4a4c8ffd2d45ad4b4868328b6b_MD5.png]]

1、我们点击右边的`...`之后就可以显示收藏和喜欢的功能

![[00 assets/b07bff85ab968d8ba1b8c2a312e99a91_MD5.png]]

2、监听点击事件，这里存在事件冒泡的问题，可以使用`catchtap`来阻止事件冒泡

![[00 assets/faaed9226788e61b92345c024d44ffa7_MD5.png]]

3、对应的选择界面，我们使用微信小程序自带的`API`，也就是`wxx.showActionSheet`，它会给`success`传递选择的`index`值

![[00 assets/77c799ed6e21fc1b9d181846d210f8c1_MD5.png]]

4、点击之后要对对应的歌曲进行收藏和喜欢的操作，这里我提前在云数据库中创建了集合

![[00 assets/6e8e305bc66035cc33e9455a5beb6b4d_MD5.png]]

5、点击之后要将对应的数据插入到数据库中

6、因为使用了云开发的能力，所以我们在传入数据的时候会默认生成`_openid`，这是用户的`openid`。不需要我们去做额外的操作![[00 assets/1022439c43e44b81ebe3d9e4f6a1cc9f_MD5.png]]

### 11.9.5 收藏/喜欢/历史页面跳转

1、存在不同的页面，我这里使用`tabs`变量来控制

![[00 assets/4b9c6dd1ed8edbf1e5d2b64f1343f56b_MD5.png]]

2、使用变量就可以控制跳转的页面了，并且传入对应的参数

![[00 assets/59819a80c45abde8fe2f311d6385fd58_MD5.png]]

3、根据传入的`type`来执行不同的函数，并且通过`openid`来获取对应的值，在页面中展示即可

![[00 assets/a97df1c2c2d229da0700baa5e2799437_MD5.png]]

这里也可以不使用`openid`来判断，因为云数据库中存在权限设置，直接勾选`仅创建者可读写`就可以实现`openid`区分用户的操作

![[00 assets/f53161192b5df92a70089efabc9971df_MD5.png]]

### 11.9.6 歌单功能 - 追加数据

1、这个就不过多的介绍了，和之前的流程是一样的

2、但是这里存在一个问题，我们需要对歌单数据进行追加，相对应的也提供了对应的`commond`，只需要`cmd.push()`就可以追加对应的数据

![[00 assets/266f258f59f8001e1561994905bc0ce6_MD5.png]]

3、并且还有一个架构设计上的思想，因为歌单数据都是统一的，最好的方式就是将歌单数据统一进行管理，这样我们在任何页面都可以监听到

![[00 assets/9eba51eacc2a68789bb15e84a82f6d2d_MD5.png]]

4、剩下的开发流程基本就是一样的了，对数据的增删改查，并且在页面中进行展示
