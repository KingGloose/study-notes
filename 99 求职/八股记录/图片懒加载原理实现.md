
---
### ğŸ¤– Assistant

ä¸‹é¢ä¸ºæ‚¨å±•ç¤ºä¸€ä¸ªåŸºäº Vue 3 çš„å›¾ç‰‡æ‡’åŠ è½½ç»„ä»¶å®Œæ•´å®ç°æ–¹æ¡ˆï¼ŒåŒ…å« **æ ¸å¿ƒåŠŸèƒ½**ã€**æ€§èƒ½ä¼˜åŒ–** å’Œ **æ‰©å±•èƒ½åŠ›**ï¼š

---

### ä¸€ã€ç»„ä»¶è®¾è®¡æ€è·¯
```bash
1. æ ¸å¿ƒåŠŸèƒ½
   âœ… è§†å£æ£€æµ‹
   âœ… åŠ è½½çŠ¶æ€ç®¡ç†
   âœ… é”™è¯¯å¤„ç†
   âœ… è‡ªé€‚åº”å®¹å™¨

2. ä¼˜åŒ–æ–¹å‘
   ğŸ“¦ æŒ‰éœ€åŠ è½½èµ„æº
   âš¡ IntersectionObserver + æ»šåŠ¨æ£€æµ‹åŒæ¨¡å¼
   ğŸ¨ å¯å®šåˆ¶å ä½å†…å®¹
   ğŸ“± å“åº”å¼å›¾ç‰‡æ”¯æŒ

3. API è®¾è®¡åŸåˆ™
   ğŸ§© å£°æ˜å¼è¯­æ³•
   ğŸ”§ å¯é…ç½®åŒ–å‚æ•°
   ğŸ“¡ äº‹ä»¶åé¦ˆç³»ç»Ÿ
```

---

### äºŒã€å®Œæ•´ç»„ä»¶ä»£ç 
```vue
<template>
  <div class="lazy-container" :style="containerStyle">
    <!-- åŠ è½½å ä½ -->
    <div v-if="status === 'pending'" class="placeholder">
      <slot name="placeholder">
        <div class="default-placeholder"></div>
      </slot>
    </div>

    <!-- åŠ è½½ä¸­ -->
    <div v-if="status === 'loading'" class="loading">
      <slot name="loading">
        <div class="spinner"></div>
      </slot>
    </div>

    <!-- çœŸå®å›¾ç‰‡ -->
    <img
      v-show="status === 'loaded'"
      :src="realSrc"
      :class="imgClass"
      :style="imgStyle"
      :alt="alt"
      @load="handleLoad"
      @error="handleError"
    >

    <!-- é”™è¯¯çŠ¶æ€ -->
    <div v-if="status === 'error'" class="error">
      <slot name="error">
        <div class="error-text">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
      </slot>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount, watch } from 'vue'

const props = defineProps({
  src: { type: String, required: true },
  alt: { type: String, default: '' },
  root: { type: Element, default: null },
  rootMargin: { type: String, default: '0px 0px 200px 0px' }, // æå‰åŠ è½½
  threshold: { type: Number, default: 0.1 },
  useObserver: { type: Boolean, default: true }, // æ˜¯å¦ä½¿ç”¨Observer
  immediate: { type: Boolean, default: false }, // ç«‹å³åŠ è½½
  imgClass: { type: String, default: '' },
  imgStyle: { type: Object, default: () => ({}) },
  containerStyle: { type: Object, default: () => ({}) }
})

const emit = defineEmits(['load', 'error'])

const status = ref('pending') // pending | loading | loaded | error
const realSrc = ref('')
let observer = null

// æ ¸å¿ƒæ£€æµ‹é€»è¾‘
const checkInView = () => {
  if (props.immediate) {
    loadImage()
    return
  }

  if ('IntersectionObserver' in window && props.useObserver) {
    initObserver()
  } else {
    initScrollListener()
    checkVisibility() // åˆå§‹æ£€æŸ¥
  }
}

// ç°ä»£æ¨¡å¼ï¼šIntersectionObserver
const initObserver = () => {
  observer = new IntersectionObserver(
    (entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          loadImage()
          observer.unobserve(entry.target)
        }
      })
    },
    {
      root: props.root,
      rootMargin: props.rootMargin,
      threshold: props.threshold
    }
  )
  observer.observe(document.querySelector('.lazy-container'))
}

// å…¼å®¹æ¨¡å¼ï¼šæ»šåŠ¨ç›‘å¬
const initScrollListener = () => {
  const scrollContainer = props.root || window
  scrollContainer.addEventListener('scroll', checkVisibility, { passive: true })
  window.addEventListener('resize', checkVisibility)
}

const checkVisibility = () => {
  const container = document.querySelector('.lazy-container')
  const rect = container.getBoundingClientRect()
  const isVisible = (
    rect.top <= window.innerHeight + 200 && // æå‰åŠ è½½
    rect.bottom >= -200 &&
    rect.left <= window.innerWidth &&
    rect.right >= -200
  )
  if (isVisible) loadImage()
}

// å›¾ç‰‡åŠ è½½æ§åˆ¶
const loadImage = () => {
  status.value = 'loading'
  realSrc.value = props.src
}

const handleLoad = (e) => {
  status.value = 'loaded'
  emit('load', e)
  cleanUp()
}

const handleError = (e) => {
  status.value = 'error'
  emit('error', e)
  cleanUp()
}

// èµ„æºæ¸…ç†
const cleanUp = () => {
  if (observer) {
    observer.disconnect()
  }
  const scrollContainer = props.root || window
  scrollContainer.removeEventListener('scroll', checkVisibility)
  window.removeEventListener('resize', checkVisibility)
}

// ç›‘å¬srcå˜åŒ–
watch(() => props.src, (newVal) => {
  status.value = 'pending'
  realSrc.value = ''
  checkInView()
})

// ç”Ÿå‘½å‘¨æœŸ
onMounted(checkInView)
onBeforeUnmount(cleanUp)
</script>

<style scoped>
.lazy-container {
  position: relative;
  overflow: hidden;
}

.default-placeholder {
  width: 100%;
  height: 100%;
  background: #f0f0f0;
}

.loading .spinner {
  /* è‡ªå®šä¹‰åŠ è½½åŠ¨ç”»æ ·å¼ */
}

.error .error-text {
  color: #ff4d4f;
}

img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: opacity 0.3s;
}

img:not([loaded]) {
  opacity: 0;
}
</style>
```

---

### ä¸‰ã€ç»„ä»¶æ ¸å¿ƒèƒ½åŠ›è§£æ

#### 1. æ™ºèƒ½åŠ è½½æ¨¡å¼
```javascript
// è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ£€æµ‹æ–¹æ¡ˆ
if ('IntersectionObserver' in window && props.useObserver) {
  initObserver() // ç°ä»£æµè§ˆå™¨
} else {
  initScrollListener() // å…¼å®¹æ–¹æ¡ˆ
}
```

#### 2. å“åº”å¼å›¾ç‰‡æ”¯æŒ
```html
<!-- ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹ -->
<LazyImage
  src="/high-res.jpg"
  srcset="/small.jpg 480w, /medium.jpg 768w"
  sizes="(max-width: 600px) 480px, 800px"
/>
```

#### 3. å¤šå®¹å™¨æ”¯æŒ
```html
<!-- åœ¨è‡ªå®šä¹‰æ»šåŠ¨å®¹å™¨ä¸­ä½¿ç”¨ -->
<div class="custom-scroll" style="height: 500px; overflow: auto">
  <LazyImage 
    :root="document.querySelector('.custom-scroll')"
    src="image.jpg"
  />
</div>
```

---

### å››ã€ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹

#### åŸºç¡€ç”¨æ³•
```html
<template>
  <LazyImage
    src="/real-image.jpg"
    alt="ç¤ºä¾‹å›¾ç‰‡"
    :rootMargin="'0px 0px 300px 0px'"
    @load="handleImageLoad"
  />
</template>
```

#### è‡ªå®šä¹‰æ’æ§½
```html
<LazyImage src="image.jpg">
  <template #placeholder>
    <div class="skeleton"></div>
  </template>
  
  <template #loading>
    <div class="custom-loader"></div>
  </template>

  <template #error>
    <div class="error-card">
      <span>âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥</span>
      <button @click="retryLoad">é‡è¯•</button>
    </div>
  </template>
</LazyImage>
```

#### å¼ºåˆ¶ç«‹å³åŠ è½½
```html
<LazyImage 
  :immediate="true" 
  src="important-image.jpg"
/>
```

---

### äº”ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 1. è¯·æ±‚ä¼˜å…ˆçº§æ§åˆ¶
```javascript
// æ ¹æ®è¿æ¥ç±»å‹åŠ è½½ä¸åŒèµ„æº
const loadImage = () => {
  const connection = navigator.connection || navigator.mozConnection
  const isSlow = connection?.effectiveType.includes('2g')
  
  realSrc.value = isSlow ? props.lowQualitySrc : props.src
}
```

#### 2. å†…å­˜ç®¡ç†ä¼˜åŒ–
```javascript
// ç»„ä»¶å¸è½½æ—¶æ¸…ç†èµ„æº
onBeforeUnmount(() => {
  if (observer) observer.disconnect()
  window.removeEventListener('resize', checkVisibility)
})
```

#### 3. åŠ è½½å¤±è´¥é‡è¯•
```javascript
// æ·»åŠ é‡è¯•é€»è¾‘
const retryCount = ref(0)

const handleError = () => {
  if (retryCount.value < 3) {
    setTimeout(() => {
      realSrc.value = `${props.src}?retry=${retryCount.value}`
      retryCount.value++
    }, 1000 * retryCount.value)
  }
}
```

---

### å…­ã€æ‰©å±•èƒ½åŠ›å»ºè®®

#### 1. æ·»åŠ æ·¡å…¥åŠ¨ç”»
```css
/* åœ¨styleéƒ¨åˆ†æ·»åŠ  */
img {
  opacity: 0;
  transition: opacity 0.5s ease-in;
}

img[data-loaded="true"] {
  opacity: 1;
}
```

#### 2. æ”¯æŒWebPæ£€æµ‹
```javascript
// è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ ¼å¼
const supportsWebP = document.createElement('canvas')
  .toDataURL('image/webp')
  .indexOf('data:image/webp') === 0

realSrc.value = supportsWebP ? props.webpSrc : props.fallbackSrc
```

#### 3. é›†æˆå›¾ç‰‡é¢„åŠ è½½
```javascript
// é¢„åŠ è½½ç›¸é‚»å›¾ç‰‡
const preloadNeighbors = () => {
  const allImages = document.querySelectorAll('.lazy-image')
  const currentIndex = Array.from(allImages).indexOf(el.value)
  
  [currentIndex - 1, currentIndex + 1].forEach(i => {
    if (allImages[i]) allImages[i].startLoading()
  })
}
```

---

### ä¸ƒã€ç»„ä»¶æµ‹è¯•æ–¹æ¡ˆ

#### 1. å¯è§†æ€§æµ‹è¯•
```javascript
// ä½¿ç”¨ Cypress æµ‹è¯•
cy.get('.lazy-container')
  .scrollIntoView()
  .should('have.attr', 'src', 'expected-image.jpg')
```

#### 2. æ€§èƒ½æŒ‡æ ‡éªŒè¯
```javascript
// æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ—¶åº
cy.intercept('GET', '/images/*').as('imageLoad')
cy.wait('@imageLoad').its('response.statusCode').should('eq', 200)
```

#### 3. é”™è¯¯è¾¹ç•Œæµ‹è¯•
```javascript
// æ¨¡æ‹ŸåŠ è½½å¤±è´¥
cy.intercept('GET', '/test-image.jpg', { statusCode: 404 })
cy.get('.error').should('be.visible')
```

---

è¿™ä¸ªç»„ä»¶æ–¹æ¡ˆå…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š
1. **æ™ºèƒ½åŠ è½½ç­–ç•¥**ï¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ£€æµ‹æ–¹æ¡ˆ
2. **å®Œæ•´çŠ¶æ€ç®¡ç†**ï¼šè¦†ç›–åŠ è½½å…¨ç”Ÿå‘½å‘¨æœŸ
3. **é«˜æ€§èƒ½å®ç°**ï¼šå†…å­˜æ³„æ¼é˜²æŠ¤ + æ™ºèƒ½æ¸…ç†
4. **å¼ºæ‰©å±•èƒ½åŠ›**ï¼šé€šè¿‡æ’æ§½å’Œäº‹ä»¶ç³»ç»Ÿæ”¯æŒæ·±åº¦å®šåˆ¶
5. **æ¸è¿›å¢å¼º**ï¼šæ”¯æŒç°ä»£ç‰¹æ€§åŒæ—¶ä¿æŒå‘ä¸‹å…¼å®¹

å»ºè®®é…åˆ **Vite** æ‰“åŒ…å·¥å…·ä½¿ç”¨ï¼Œé€šè¿‡ Tree-shaking ç¡®ä¿æœ€ç»ˆæ‰“åŒ…ä½“ç§¯æœ€ä¼˜ã€‚å¯¹äºéœ€è¦æ›´é«˜æ€§èƒ½çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ç»“åˆ **IntersectionObserver V2** å®ç°æ›´ç²¾å‡†çš„å¯è§†æ€§æ£€æµ‹ã€‚